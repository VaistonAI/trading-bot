rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para verificar autenticación
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función helper para verificar si es admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Función helper para verificar si es el mismo usuario
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Colección de usuarios
    match /users/{userId} {
      // Lectura: usuario autenticado puede leer su propio documento o admin puede leer todos
      allow read: if isOwner(userId) || isAdmin();
      
      // Creación: usuario puede crear su propio documento (durante registro) o admin puede crear cualquiera
      allow create: if isOwner(userId) || isAdmin();
      
      // Actualización: usuario puede actualizar su propio perfil o admin puede actualizar cualquiera
      allow update: if isOwner(userId) || isAdmin();
      
      // Eliminación: solo admin
      allow delete: if isAdmin();
    }
    
    // Colección de estrategias
    match /strategies/{strategyId} {
      // Lectura: cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Escritura: solo admin
      allow create, update, delete: if isAdmin();
    }
    
    // Colección de trades (operaciones)
    match /trades/{tradeId} {
      // Lectura: cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Escritura: solo admin
      allow create, update, delete: if isAdmin();
    }
    
    // Colección de posiciones
    match /positions/{positionId} {
      // Lectura: cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Escritura: solo admin
      allow create, update, delete: if isAdmin();
    }
    
    // Colección de notificaciones
    match /notifications/{notificationId} {
      // Lectura: cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Escritura: solo admin
      allow create, update, delete: if isAdmin();
    }
    
    
    // Colección de invitaciones
    match /invitations/{invitationId} {
      // Lectura: cualquier persona puede leer (necesario para validar token durante registro)
      allow read: if true;
      
      // Creación: solo admin puede crear invitaciones
      allow create: if isAdmin();
      
      // Actualización: admin o usuario autenticado puede actualizar (necesario para marcar como aceptada)
      allow update: if isAdmin() || isAuthenticated();
      
      // Eliminación: solo admin puede eliminar invitaciones
      allow delete: if isAdmin();
    }
    
    // Colección de alertas (paper trading)
    match /alerts/{alertId} {
      // Lectura: cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Escritura: usuarios autenticados pueden crear y actualizar sus alertas
      allow create, update: if isAuthenticated();
      
      // Eliminación: solo admin
      allow delete: if isAdmin();
    }
    
    // Regla por defecto: denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
